<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/jpeg" href="nova-icon.jpg">
    <title>Nova Monitoring ⭐</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
            --accent: #58a6ff;
            --success: #3fb950;
            --warning: #d29922;
            --error: #f85149;
            --border: #30363d;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 1rem;
        }
        
        .container { max-width: 1400px; margin: 0 auto; }
        
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1.5rem;
        }
        
        header h1 {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem;
        }
        
        .nav-links {
            display: flex;
            gap: 1rem;
        }
        
        .nav-links a {
            color: var(--text-secondary);
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .nav-links a:hover, .nav-links a.active {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.25rem;
        }
        
        .stat-card h3 {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        
        .stat-card .value {
            font-size: 1.75rem;
            font-weight: 600;
        }
        
        .stat-card .subtext {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .chart-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.25rem;
        }
        
        .chart-card h3 {
            font-size: 1rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }
        
        .chart-container {
            position: relative;
            height: 250px;
        }
        
        .config-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .config-section label {
            display: block;
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        
        .config-row {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .config-row input {
            flex: 1;
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            font-family: monospace;
        }
        
        .config-row button {
            padding: 0.5rem 1rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .config-row button:hover {
            opacity: 0.9;
        }
        
        .status {
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.875rem;
            margin-top: 1rem;
        }
        
        .status.success { background: rgba(63, 185, 80, 0.2); color: var(--success); }
        .status.error { background: rgba(248, 81, 73, 0.2); color: var(--error); }
        
        .latency-bars {
            display: flex;
            gap: 1rem;
            justify-content: space-around;
            padding: 1rem 0;
        }
        
        .latency-bar {
            text-align: center;
        }
        
        .latency-bar .bar {
            width: 60px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            margin: 0 auto 0.5rem;
            position: relative;
            height: 120px;
        }
        
        .latency-bar .fill {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            border-radius: 4px;
            transition: height 0.3s;
        }
        
        .latency-bar .label {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        .latency-bar .value {
            font-size: 1rem;
            font-weight: 600;
            margin-top: 0.25rem;
        }
        
        footer {
            text-align: center;
            padding: 1rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
            border-top: 1px solid var(--border);
            margin-top: 2rem;
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>⭐ Nova Monitoring</h1>
            <nav class="nav-links">
                <a href="index.html">Dashboard</a>
                <a href="monitoring.html" class="active">Monitoring</a>
            </nav>
        </header>
        
        <div class="config-section">
            <label>Metrics URL (JSON endpoint)</label>
            <div class="config-row">
                <input type="text" id="metricsUrl" placeholder="https://your-server/metrics.json">
                <button onclick="loadMetrics()">Load Metrics</button>
            </div>
            <div id="status"></div>
        </div>
        
        <div id="content" class="loading">
            Enter a metrics URL above to load monitoring data
        </div>
    </div>
    
    <script>
        let charts = {};
        
        function formatNumber(n) {
            if (n >= 1e9) return (n / 1e9).toFixed(2) + 'B';
            if (n >= 1e6) return (n / 1e6).toFixed(2) + 'M';
            if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
            return n.toLocaleString();
        }
        
        function formatCost(n) {
            return '$' + n.toFixed(2);
        }
        
        function formatMs(ms) {
            if (ms >= 60000) return (ms / 60000).toFixed(1) + 'm';
            if (ms >= 1000) return (ms / 1000).toFixed(1) + 's';
            return ms + 'ms';
        }
        
        async function loadMetrics() {
            const url = document.getElementById('metricsUrl').value.trim();
            const statusEl = document.getElementById('status');
            const contentEl = document.getElementById('content');
            
            if (!url) {
                statusEl.className = 'status error';
                statusEl.textContent = 'Please enter a metrics URL';
                return;
            }
            
            localStorage.setItem('nova_metrics_url', url);
            statusEl.className = 'status';
            statusEl.textContent = 'Loading...';
            contentEl.innerHTML = '<div class="loading">Loading metrics...</div>';
            
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const metrics = await response.json();
                
                statusEl.className = 'status success';
                statusEl.textContent = `Loaded metrics from ${new Date(metrics.generatedAt).toLocaleString()} (${metrics.periodHours}h period)`;
                
                renderMetrics(metrics);
            } catch (err) {
                statusEl.className = 'status error';
                statusEl.textContent = `Error: ${err.message}`;
                contentEl.innerHTML = '<div class="loading">Failed to load metrics</div>';
            }
        }
        
        function renderMetrics(m) {
            const contentEl = document.getElementById('content');
            
            // Calculate success rate (messages without errors)
            const totalAttempts = m.messages.user;
            const successRate = totalAttempts > 0 
                ? ((totalAttempts - m.messages.errors) / totalAttempts * 100).toFixed(1)
                : 100;
            
            contentEl.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Messages</h3>
                        <div class="value">${formatNumber(m.messages.total)}</div>
                        <div class="subtext">${m.messages.user} user / ${m.messages.assistant} assistant</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Tokens</h3>
                        <div class="value">${formatNumber(m.tokens.total)}</div>
                        <div class="subtext">${formatNumber(m.tokens.output)} output / ${formatNumber(m.tokens.cacheRead)} cache</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Cost</h3>
                        <div class="value">${formatCost(m.cost.total)}</div>
                        <div class="subtext">Over ${m.periodHours} hours</div>
                    </div>
                    <div class="stat-card">
                        <h3>Success Rate</h3>
                        <div class="value" style="color: ${parseFloat(successRate) > 95 ? 'var(--success)' : 'var(--warning)'}">${successRate}%</div>
                        <div class="subtext">${m.messages.errors} errors</div>
                    </div>
                    <div class="stat-card">
                        <h3>Avg Latency</h3>
                        <div class="value">${formatMs(m.latency.avgMs)}</div>
                        <div class="subtext">P50: ${formatMs(m.latency.p50Ms)} / P95: ${formatMs(m.latency.p95Ms)}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active Sessions</h3>
                        <div class="value">${m.sessions.active}</div>
                        <div class="subtext">of ${m.sessions.total} total</div>
                    </div>
                </div>
                
                <div class="charts-grid">
                    <div class="chart-card">
                        <h3>Cost by Day</h3>
                        <div class="chart-container">
                            <canvas id="costChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>Activity by Hour (Last 24h)</h3>
                        <div class="chart-container">
                            <canvas id="activityChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>Latency Distribution</h3>
                        <div class="latency-bars">
                            <div class="latency-bar">
                                <div class="bar">
                                    <div class="fill" style="height: ${Math.min(100, m.latency.avgMs / 300)}%; background: var(--accent)"></div>
                                </div>
                                <div class="label">Average</div>
                                <div class="value">${formatMs(m.latency.avgMs)}</div>
                            </div>
                            <div class="latency-bar">
                                <div class="bar">
                                    <div class="fill" style="height: ${Math.min(100, m.latency.p50Ms / 300)}%; background: var(--success)"></div>
                                </div>
                                <div class="label">P50</div>
                                <div class="value">${formatMs(m.latency.p50Ms)}</div>
                            </div>
                            <div class="latency-bar">
                                <div class="bar">
                                    <div class="fill" style="height: ${Math.min(100, m.latency.p95Ms / 300)}%; background: var(--warning)"></div>
                                </div>
                                <div class="label">P95</div>
                                <div class="value">${formatMs(m.latency.p95Ms)}</div>
                            </div>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>Token Breakdown</h3>
                        <div class="chart-container">
                            <canvas id="tokenChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <footer>
                    Generated at ${new Date(m.generatedAt).toLocaleString()} • ${m.periodHours}h period • ${m.latency.samples} samples
                </footer>
            `;
            
            renderCharts(m);
        }
        
        function renderCharts(m) {
            // Destroy existing charts
            Object.values(charts).forEach(c => c.destroy?.());
            
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { labels: { color: '#8b949e' } }
                },
                scales: {
                    x: { ticks: { color: '#8b949e' }, grid: { color: '#30363d' } },
                    y: { ticks: { color: '#8b949e' }, grid: { color: '#30363d' } }
                }
            };
            
            // Cost by Day
            const costDays = Object.keys(m.cost.byDay).sort();
            charts.cost = new Chart(document.getElementById('costChart'), {
                type: 'bar',
                data: {
                    labels: costDays.map(d => d.slice(5)), // MM-DD
                    datasets: [{
                        label: 'Cost ($)',
                        data: costDays.map(d => m.cost.byDay[d]),
                        backgroundColor: '#58a6ff'
                    }]
                },
                options: chartOptions
            });
            
            // Activity by Hour (last 24h)
            const now = new Date();
            const hours = [];
            for (let i = 23; i >= 0; i--) {
                const h = new Date(now - i * 3600000);
                hours.push(h.toISOString().slice(0, 13));
            }
            charts.activity = new Chart(document.getElementById('activityChart'), {
                type: 'line',
                data: {
                    labels: hours.map(h => h.slice(11) + ':00'),
                    datasets: [{
                        label: 'Messages',
                        data: hours.map(h => m.activity.byHour[h] || 0),
                        borderColor: '#3fb950',
                        backgroundColor: 'rgba(63, 185, 80, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: chartOptions
            });
            
            // Token Breakdown
            charts.tokens = new Chart(document.getElementById('tokenChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Output', 'Cache Read', 'Cache Write', 'Input'],
                    datasets: [{
                        data: [m.tokens.output, m.tokens.cacheRead, m.tokens.cacheWrite, m.tokens.input],
                        backgroundColor: ['#58a6ff', '#3fb950', '#d29922', '#f85149']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'right',
                            labels: { color: '#8b949e' } 
                        }
                    }
                }
            });
        }
        
        // Load saved URL on page load
        window.addEventListener('DOMContentLoaded', () => {
            const savedUrl = localStorage.getItem('nova_metrics_url');
            if (savedUrl) {
                document.getElementById('metricsUrl').value = savedUrl;
                loadMetrics();
            }
        });
    </script>
</body>
</html>
